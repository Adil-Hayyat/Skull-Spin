<script type="module">
  import { signup, login, logout, auth, getBalance, updateBalance } from "./auth.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const signupBtn = document.getElementById("signupBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const addBalanceBtn = document.getElementById("addBalanceBtn");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const userInfo = document.getElementById("userInfo");

  let currentUser = null;
  let currentBalance = 0;

  // signup
  signupBtn.addEventListener("click", () => {
    const email = prompt("Enter email:");
    const password = prompt("Enter password (min 6 chars):");

    if (!email || !password) {
      alert("Email and password are required!");
      return;
    }
    if (password.length < 6) {
      alert("Password must be at least 6 characters long!");
      return;
    }

    signup(email, password);
  });

  // login
  loginBtn.addEventListener("click", () => {
    const email = prompt("Enter email:");
    const password = prompt("Enter password:");
    login(email, password);
  });

  // logout
  logoutBtn.addEventListener("click", () => {
    logout();
  });

  // Add Balance
  window.addBalance = async () => {
    if (currentUser) {
      currentBalance += 100; // har add pe 100 PKR
      await updateBalance(currentUser.uid, currentBalance);
      userInfo.textContent = `Balance: ${currentBalance} PKR`;
    }
  };

  // Withdraw
  window.withdraw = async () => {
    if (currentUser && currentBalance >= 50) {
      currentBalance -= 50; // withdraw 50 PKR
      await updateBalance(currentUser.uid, currentBalance);
      userInfo.textContent = `Balance: ${currentBalance} PKR`;
    } else {
      alert("Not enough balance!");
    }
  };

  // Auth state change
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      currentBalance = await getBalance(user.uid);
      userInfo.textContent = `Balance: ${currentBalance} PKR`;

      signupBtn.style.display = "none";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      addBalanceBtn.style.display = "inline-block";
      withdrawBtn.style.display = "inline-block";
    } else {
      currentUser = null;
      currentBalance = 0;
      userInfo.textContent = "Balance: 0 PKR";

      signupBtn.style.display = "inline-block";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      addBalanceBtn.style.display = "none";
      withdrawBtn.style.display = "none";
    }
  });
</script>
